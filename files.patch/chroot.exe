#!/bin/bash

# DEFINES

offset="$(pwd)"

mSize="$(awk '$3=="kB"{$2=$2/1024^2;$3="GB";} 1' /proc/meminfo | column -t | grep 'MemFree' | awk '{print $2}')"
mSize="${mSize%%.*}"
mSize=$(expr $mSize / 2)
mSize="${mSize}G"
# MOUNTS

echo "msize = $mSize"

mount -t proc proc $offset/proc
mount --rbind /sys $offset/sys
mount --make-rslave $offset/sys
mount --rbind /dev $offset/dev
mount --make-rslave $offset/dev



# because autofs doesn't work right in a chroot ...
mount -t tmpfs -o size=$mSize tmpfs $offset/tmp
mount -t tmpfs tmpfs $offset/var/tmp
mount -t tmpfs tmpfs $offset/run

#mount -t nfs earth.hypokrites.me:/gentoo-distfiles $(pwd)/var/lib/portage/distfiles || echo "unable to mount distfiles !"
#mount -t nfs earth.hypokrites.me:/gentoo-pkgs $(pwd)/var/lib/portage/binpkgs || echo "unable to mount binpkgs !"

## RUN
#mount -t nfs 192.168.2.200:/gentoo-distfiles $(pwd)/var/lib/portage/distfiles || echo "unable to mount distfiles !"
#mount -t nfs 192.168.2.200:/gentoo-pkgs $(pwd)/var/lib/portage/binpkgs || echo "unable to mount binpkgs !"

#mount --bind /var/lib/portage/binpkgs $offset/var/lib/portage/binpkgs
#mount --bind /var/lib/portage/distfiles $offset/var/lib/portage/distfiles

export PYTHONPATH=""

#PS1="(chroot) $PS1"

#chroot $offset /bin/zsh
chroot $offset /bin/bash



